name: Main Workflow

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: "main"
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Deploy documentation
  deploy-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git Credentials
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: echo "cache_id=$(date --utc '+%V')" >> $GITHUB_ENV

      - uses: actions/cache@v4
        with:
          key: mkdocs-material-${{ env.cache_id }}
          path: .cache
          restore-keys: |
            mkdocs-material-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs-material pymdown-extensions mkdocs-material-extensions

      - name: Build and Deploy
        run: |
          mkdocs build
          # 确保 admin 目录被复制到输出
          cp -r docs/admin site/admin
          mkdocs gh-deploy --force

  # Update contributors list from GitHub API
  update-contributors:
    runs-on: ubuntu-latest
    needs: deploy-docs
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML requests

      - name: Generate contributors list
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 scripts/generate_contributors.py \
            --owner ${{ github.repository_owner }} \
            --repo ${{ github.event.repository.name }} \
            --output docs/data/contributors.yml

      - name: Generate contributors markdown
        run: |
          python3 << 'EOF'
          import yaml
          import os

          try:
              yaml_path = 'docs/data/contributors.yml'
              if not os.path.exists(yaml_path):
                  print(f"Warning: {yaml_path} not found, creating empty contributors list")
                  contributors = []
              else:
                  with open(yaml_path, 'r', encoding='utf-8') as f:
                      data = yaml.safe_load(f)
                      contributors = data if isinstance(data, list) else (data.get('contributors', []) if isinstance(data, dict) else [])

              markdown = "## 贡献者\n\n"
              markdown += f"感谢 {len(contributors)} 位贡献者的支持：\n\n"
              markdown += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin: 20px 0;">\n'

              for contributor in contributors[:20]:
                  login = contributor.get('login', 'Unknown')
                  avatar = contributor.get('avatar_url', '')
                  html_url = contributor.get('html_url', '')
                  contributions = contributor.get('contributions', 0)

                  if avatar and html_url:
                      markdown += f'  <a href="{html_url}" title="{login} ({contributions} contributions)" style="text-decoration: none;">\n'
                      markdown += f'    <img src="{avatar}&s=120" width="60" height="60" alt="{login}" style="border-radius: 50%; margin: 5px;" />\n'
                      markdown += f'  </a>\n'

              markdown += '</div>\n\n'
              markdown += "想让名字出现在这里？发起 PR 贡献代码或内容吧！\n\n"
              markdown += f"[查看所有 {len(contributors)} 位贡献者](https://github.com/${{ github.repository }}/graphs/contributors)\n"

              os.makedirs('docs/data', exist_ok=True)
              with open('docs/data/contributors.md', 'w', encoding='utf-8') as f:
                  f.write(markdown)

              print(f"Generated contributors markdown with {len(contributors)} contributors")

          except Exception as e:
              print(f"Error: {e}")
              import traceback
              traceback.print_exc()
              exit(1)
          EOF

      - name: Check if contributors changed
        id: verify-contributors
        run: |
          if git diff --quiet docs/data/; then
            echo "contributors_changed=false" >> $GITHUB_OUTPUT
          else
            echo "contributors_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit contributors changes
        if: steps.verify-contributors.outputs.contributors_changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/data/contributors.yml docs/data/contributors.md
          git commit -m "chore: update contributors list"
          git push origin main
