name: Deploy to GitHub Pages

on:
  push:
    branches:
      - deploy
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Á¨¨‰∏ÄÊ≠•ÔºöÊõ¥Êñ∞Ë¥°ÁåÆËÄÖÂàóË°®Ôºà‰ªéGitHub APIËé∑ÂèñÔºâ
  update-contributors:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout deploy branch
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML requests

      - name: Generate contributors list
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 scripts/generate_contributors.py \
            --owner minamotooRin \
            --repo KU-WIKI \
            --output docs/data/contributors.yml

      - name: Generate contributors markdown
        run: |
          python3 << 'EOF'
          import yaml
          import os
          
          try:
              # Read contributors YAML
              yaml_path = 'docs/data/contributors.yml'
              if not os.path.exists(yaml_path):
                  print(f"Warning: {yaml_path} not found, creating empty contributors list")
                  contributors = []
              else:
                  with open(yaml_path, 'r', encoding='utf-8') as f:
                      data = yaml.safe_load(f)
                      contributors = data if isinstance(data, list) else (data.get('contributors', []) if isinstance(data, dict) else [])
              
              # Generate markdown snippet
              markdown = "## Ë¥°ÁåÆËÄÖÔºàÂêëÊúâÁà±ÁöÑ‰∫∫Ëá¥Ë∞¢Ôºâ\n\n"
              markdown += f"ÊÑüË∞¢ {len(contributors)} ‰ΩçË¥°ÁåÆËÄÖÁöÑÊîØÊåÅÔºö\n\n"
              
              # Generate contributor grid
              markdown += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin: 20px 0;">\n'
              
              for contributor in contributors[:20]:  # Show top 20
                  login = contributor.get('login', 'Unknown')
                  avatar = contributor.get('avatar_url', '')
                  html_url = contributor.get('html_url', '')
                  contributions = contributor.get('contributions', 0)
                  
                  if avatar and html_url:
                      markdown += f'  <a href="{html_url}" title="{login} ({contributions} contributions)" style="text-decoration: none;">\n'
                      markdown += f'    <img src="{avatar}&s=120" width="60" height="60" alt="{login}" style="border-radius: 50%; margin: 5px;" />\n'
                      markdown += f'  </a>\n'
              
              markdown += '</div>\n\n'
              markdown += "ÊÉ≥ËÆ©ÂêçÂ≠óÂá∫Áé∞Âú®ËøôÈáåÔºüÂèëËµ∑ PR Ë¥°ÁåÆ‰ª£Á†ÅÊàñÂÜÖÂÆπÂêßÔºÅ\n\n"
              markdown += f"üëâ [Êü•ÁúãÊâÄÊúâ {len(contributors)} ‰ΩçË¥°ÁåÆËÄÖ](https://github.com/minamotooRin/KU-WIKI/graphs/contributors)\n"
              
              # Ensure directory exists
              output_dir = 'docs/data'
              os.makedirs(output_dir, exist_ok=True)
              
              # Write to file with error handling
              output_path = os.path.join(output_dir, 'contributors.md')
              with open(output_path, 'w', encoding='utf-8') as f:
                  f.write(markdown)
              
              print(f"Successfully generated contributors markdown: {output_path}")
              print(f"Total contributors: {len(contributors)}")
              
          except Exception as e:
              print(f"Error generating contributors markdown: {e}")
              import traceback
              traceback.print_exc()
              exit(1)
          EOF

      - name: Check if contributors changed
        id: verify-contributors
        run: |
          if git diff --quiet docs/data/; then
            echo "contributors_changed=false" >> $GITHUB_OUTPUT
          else
            echo "contributors_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit contributors changes
        if: steps.verify-contributors.outputs.contributors_changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/data/contributors.yml docs/data/contributors.md
          git commit -m "chore: update contributors list from GitHub API"
          git push origin deploy

  # Á¨¨‰∫åÊ≠•ÔºöÊûÑÂª∫ MkDocs ÁΩëÁ´ô
  build-and-deploy:
    needs: update-contributors
    runs-on: ubuntu-latest
    steps:
      - name: Checkout deploy branch
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build MkDocs site
        run: mkdocs build

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './site'

  # Á¨¨‰∏âÊ≠•ÔºöÈÉ®ÁΩ≤Âà∞ GitHub Pages
  deploy-pages:
    needs: build-and-deploy
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
