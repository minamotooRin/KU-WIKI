name: Update Contributors List

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML requests

      - name: Generate contributors list
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 scripts/generate_contributors.py \
            --owner minamotooRin \
            --repo KU-WIKI \
            --output docs/data/contributors.yml

      - name: Generate contributors markdown
        run: |
          python3 << 'EOF'
          import yaml
          import os
          
          # Read contributors YAML
          with open('docs/data/contributors.yml', 'r', encoding='utf-8') as f:
              contributors = yaml.safe_load(f) or []
          
          # Generate markdown snippet
          markdown = "## è´¡çŒ®è€…ï¼ˆå‘æœ‰çˆ±çš„äººè‡´è°¢ï¼‰\n\n"
          markdown += f"æ„Ÿè°¢ {len(contributors)} ä½è´¡çŒ®è€…çš„æ”¯æŒï¼š\n\n"
          
          # Generate contributor grid
          markdown += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin: 20px 0;">\n'
          
          for contributor in contributors[:20]:  # Show top 20
              login = contributor.get('login', 'Unknown')
              avatar = contributor.get('avatar_url', '')
              html_url = contributor.get('html_url', '')
              contributions = contributor.get('contributions', 0)
              
              if avatar and html_url:
                  markdown += f'  <a href="{html_url}" title="{login} ({contributions} contributions)" style="text-decoration: none;">\n'
                  markdown += f'    <img src="{avatar}&s=120" width="60" height="60" alt="{login}" style="border-radius: 50%; margin: 5px;" />\n'
                  markdown += f'  </a>\n'
          
          markdown += '</div>\n\n'
          markdown += "æƒ³è®©åå­—å‡ºçŽ°åœ¨è¿™é‡Œï¼Ÿå‘èµ· PR è´¡çŒ®ä»£ç æˆ–å†…å®¹å§ï¼\n\n"
          markdown += f"ðŸ‘‰ [æŸ¥çœ‹æ‰€æœ‰ {len(contributors)} ä½è´¡çŒ®è€…](https://github.com/minamotooRin/KU-WIKI/graphs/contributors)\n"
          
          # Write to file
          os.makedirs('docs/data', exist_ok=True)
          with open('docs/data/contributors.md', 'w', encoding='utf-8') as f:
              f.write(markdown)
          
          print(f"Generated contributors markdown with {len(contributors)} contributors")
          EOF

      - name: Check if changes exist
        id: verify
        run: |
          if git diff --quiet docs/data/; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.verify.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/data/contributors.yml docs/data/contributors.md
          git commit -m "chore: update contributors list from GitHub API"
          git push origin main

      - name: No changes needed
        if: steps.verify.outputs.changed == 'false'
        run: echo "Contributors list is already up to date"
